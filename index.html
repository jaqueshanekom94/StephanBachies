<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stephan Bachies Bingo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
        }
        .container {
            max-width: 480px;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            width: 100%;
        }
        .grid-cell {
            background-color: #1a1a1a;
            border: 2px solid #333;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
            color: #E0E0E0;
            transition: background-color 0.2s, color 0.2s;
            position: relative;
            overflow: hidden;
        }
        .grid-cell.called {
            background-color: #38761d;
            border-color: #2e6216;
            color: #fff;
        }
        .host-cell {
            background-color: #282828;
            border: 2px solid #444;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
            transition: background-color 0.2s;
            height: 60px;
        }
        .button {
            transition: transform 0.1s;
        }
        .button:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen p-4 flex flex-col items-center justify-center bg-gray-900">
        <!-- Message box -->
        <div id="message-box" class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full">
                <p id="message-text" class="text-xl font-semibold mb-4 text-white"></p>
                <button id="message-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full w-full">OK</button>
            </div>
        </div>

        <div id="landing-page" class="w-full flex flex-col items-center justify-center text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-400">Stephan Bachies Bingo</h1>
            <div class="space-y-4 w-full px-4">
                <button id="create-game-btn" class="button w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg">
                    Create New Game
                </button>
                <div class="flex items-center space-x-2">
                    <input type="text" id="game-id-input" placeholder="Enter Game Code" class="w-full p-4 rounded-lg bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="join-game-btn" class="button bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg whitespace-nowrap">
                        Join Game
                    </button>
                </div>
            </div>
            <p class="text-gray-400 text-sm mt-4">This app uses Firebase for real-time multiplayer functionality.</p>
        </div>

        <div id="host-view" class="hidden w-full flex flex-col items-center justify-center">
            <h2 class="text-3xl font-bold mb-4">Host Game</h2>
            <div class="flex items-center justify-center mb-4 text-center">
                <p class="text-lg font-semibold text-gray-300 mr-2">Game Code:</p>
                <span id="host-game-id" class="text-xl font-bold text-green-400 bg-gray-800 px-4 py-2 rounded-lg tracking-wider"></span>
            </div>
            <div id="host-numbers-grid" class="grid-container max-w-full"></div>
            <div class="mt-8 space-y-4 w-full">
                <button id="call-number-btn" class="button w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg">
                    Call Next Number
                </button>
            </div>
        </div>

        <div id="player-view" class="hidden w-full flex flex-col items-center justify-center">
            <h2 class="text-3xl font-bold mb-4">Player View</h2>
            <div class="flex items-center justify-center mb-4 text-center">
                <p class="text-lg font-semibold text-gray-300 mr-2">Game Code:</p>
                <span id="player-game-id" class="text-xl font-bold text-green-400 bg-gray-800 px-4 py-2 rounded-lg tracking-wider"></span>
            </div>
            <div id="bingo-card-container" class="w-full p-2 bg-gray-800 rounded-lg shadow-lg">
                <div class="grid-container">
                    <div class="grid-cell text-lg font-bold bg-green-500 text-white rounded-md">B</div>
                    <div class="grid-cell text-lg font-bold bg-green-500 text-white rounded-md">I</div>
                    <div class="grid-cell text-lg font-bold bg-green-500 text-white rounded-md">N</div>
                    <div class="grid-cell text-lg font-bold bg-green-500 text-white rounded-md">G</div>
                    <div class="grid-cell text-lg font-bold bg-green-500 text-white rounded-md">O</div>
                    <!-- Bingo card cells will be generated here -->
                </div>
            </div>
            <div class="mt-8 space-y-4 w-full">
                <button id="bingo-btn" class="button w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg">
                    BINGO!
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase configuration and imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // IMPORTANT: Use the global variables for app ID and Firebase config.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyCbhscC-kvjdpm95ZHjlz5mDIEvLr8DdCQ",
            authDomain: "stephan-bachies-bingo.firebaseapp.com",
            projectId: "stephan-bachies-bingo",
            storageBucket: "stephan-bachies-bingo.firebasestorage.app",
            messagingSenderId: "239453283683",
            appId: "1:239453283683:web:258fd20db271405f5bdf56",
            measurementId: "G-CQNRTD5D5D"
        };
        const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        
        const app = initializeApp(firebaseConfigFromEnv);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;
        let currentGameId = null;

        // UI elements
        const landingPage = document.getElementById('landing-page');
        const hostView = document.getElementById('host-view');
        const playerView = document.getElementById('player-view');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const gameIdInput = document.getElementById('game-id-input');
        const hostGameIdSpan = document.getElementById('host-game-id');
        const playerGameIdSpan = document.getElementById('player-game-id');
        const callNumberBtn = document.getElementById('call-number-btn');
        const bingoBtn = document.getElementById('bingo-btn');
        const hostNumbersGrid = document.getElementById('host-numbers-grid');
        const bingoCardContainer = document.getElementById('bingo-card-container');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageOkBtn = document.getElementById('message-ok');

        // Show custom message box instead of alert()
        const showMessage = (text) => {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        };

        messageOkBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // Sign in anonymously using the provided token
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Signed in with userId:", userId);
            } else {
                try {
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Error during sign-in:", error);
                }
            }
        });
        
        // Helper to switch views
        const showView = (view) => {
            landingPage.classList.add('hidden');
            hostView.classList.add('hidden');
            playerView.classList.add('hidden');
            view.classList.remove('hidden');
        };

        // --- Game Logic Functions ---

        // Function to generate a random bingo card (5x5 grid)
        const generateBingoCard = () => {
            const card = [];
            const generateColumn = (start, end) => {
                const column = Array.from({ length: end - start + 1 }, (_, i) => start + i);
                return column.sort(() => 0.5 - Math.random()).slice(0, 5);
            };
            card.push(...generateColumn(1, 15)); // B
            card.push(...generateColumn(16, 30)); // I
            card.push(...generateColumn(31, 45)); // N
            card.push(...generateColumn(46, 60)); // G
            card.push(...generateColumn(61, 75)); // O
            card[12] = 'FREE'; // Middle cell is free
            return card;
        };
        
        const renderPlayerCard = (card, calledNumbers) => {
            // Clear existing card cells
            const gridContainer = bingoCardContainer.querySelector('.grid-container');
            const existingCells = gridContainer.querySelectorAll('.grid-cell:not(:nth-child(-n+5))');
            existingCells.forEach(cell => cell.remove());

            card.forEach(number => {
                const cell = document.createElement('div');
                cell.classList.add('grid-cell', 'rounded-md', 'select-none');
                cell.textContent = number;
                if (number === 'FREE' || calledNumbers.includes(parseInt(number))) {
                    cell.classList.add('called');
                }
                cell.setAttribute('data-number', number);
                gridContainer.appendChild(cell);
            });
        };

        const checkBingo = (card, calledNumbers) => {
            // Create a 5x5 grid representation for easier checking
            const grid = [];
            for (let i = 0; i < 5; i++) {
                grid.push(card.slice(i * 5, (i + 1) * 5));
            }
            
            const isMarked = (num) => calledNumbers.includes(parseInt(num)) || num === 'FREE';

            // Check rows
            for (let i = 0; i < 5; i++) {
                if (grid[i].every(isMarked)) return true;
            }

            // Check columns
            for (let j = 0; j < 5; j++) {
                if (grid.every(row => isMarked(row[j]))) return true;
            }

            // Check diagonals
            if (isMarked(grid[0][0]) && isMarked(grid[1][1]) && isMarked(grid[2][2]) && isMarked(grid[3][3]) && isMarked(grid[4][4])) return true;
            if (isMarked(grid[0][4]) && isMarked(grid[1][3]) && isMarked(grid[2][2]) && isMarked(grid[3][1]) && isMarked(grid[4][0])) return true;

            return false;
        };
        
        // --- Firebase Functions ---
        
        // Create a new game in Firestore
        createGameBtn.addEventListener('click', async () => {
            if (!userId) {
                showMessage("Authentication is not ready. Please wait a moment.");
                return;
            }
            try {
                const gameDocRef = doc(db, `/artifacts/${appId}/public/data/games/${crypto.randomUUID()}`);
                const gameId = gameDocRef.id;
                
                // Initialize game state
                await setDoc(gameDocRef, {
                    hostId: userId,
                    calledNumbers: [],
                    availableNumbers: Array.from({ length: 75 }, (_, i) => i + 1),
                    status: 'waiting',
                    winner: null
                });

                currentGameId = gameId;
                hostGameIdSpan.textContent = currentGameId;
                showView(hostView);
                
                listenForGameState(gameDocRef);
                renderHostNumbersGrid([]);
            } catch (error) {
                console.error("Error creating game:", error);
                showMessage("Failed to create game. Please try again.");
            }
        });

        // Join an existing game
        joinGameBtn.addEventListener('click', async () => {
            if (!userId) {
                showMessage("Authentication is not ready. Please wait a moment.");
                return;
            }
            const gameId = gameIdInput.value.trim();
            if (!gameId) {
                showMessage("Please enter a game code.");
                return;
            }

            try {
                const gameDocRef = doc(db, `/artifacts/${appId}/public/data/games/${gameId}`);
                const gameDocSnap = await getDoc(gameDocRef);

                if (!gameDocSnap.exists()) {
                    showMessage("Game not found. Please check the code.");
                    return;
                }
                
                const gameData = gameDocSnap.data();
                if (gameData.status === 'finished') {
                     showMessage("This game has already finished.");
                     return;
                }

                currentGameId = gameId;
                const playerDocRef = doc(db, `/artifacts/${appId}/public/data/games/${currentGameId}/players/${userId}`);
                
                // Check if player is already in the game
                const playerDocSnap = await getDoc(playerDocRef);
                let bingoCard = [];
                if (playerDocSnap.exists()) {
                    bingoCard = playerDocSnap.data().card;
                } else {
                    bingoCard = generateBingoCard();
                    await setDoc(playerDocRef, {
                        card: bingoCard
                    });
                }

                playerGameIdSpan.textContent = currentGameId;
                showView(playerView);
                listenForGameState(gameDocRef, bingoCard);
            } catch (error) {
                console.error("Error joining game:", error);
                showMessage("Failed to join game. Please try again.");
            }
        });

        // Host calls a new number
        callNumberBtn.addEventListener('click', async () => {
            if (!currentGameId || !userId) return;
            
            const gameDocRef = doc(db, `/artifacts/${appId}/public/data/games/${currentGameId}`);
            const gameDocSnap = await getDoc(gameDocRef);
            const gameData = gameDocSnap.data();

            if (gameData.status === 'playing') {
                const availableNumbers = gameData.availableNumbers;
                if (availableNumbers.length === 0) {
                    showMessage("No more numbers to call!");
                    return;
                }
                const randomIndex = Math.floor(Math.random() * availableNumbers.length);
                const nextNumber = availableNumbers[randomIndex];
                
                const newAvailableNumbers = availableNumbers.filter(n => n !== nextNumber);
                const newCalledNumbers = [...gameData.calledNumbers, nextNumber];

                await updateDoc(gameDocRef, {
                    calledNumbers: newCalledNumbers,
                    availableNumbers: newAvailableNumbers
                });

            } else {
                await updateDoc(gameDocRef, { status: 'playing' });
                // Re-trigger the button click to call the first number
                callNumberBtn.click();
            }
        });

        // Player calls bingo
        bingoBtn.addEventListener('click', async () => {
            if (!currentGameId || !userId) return;
            
            const playerDocRef = doc(db, `/artifacts/${appId}/public/data/games/${currentGameId}/players/${userId}`);
            const playerDocSnap = await getDoc(playerDocRef);
            const playerCard = playerDocSnap.data().card;
            
            const gameDocRef = doc(db, `/artifacts/${appId}/public/data/games/${currentGameId}`);
            const gameDocSnap = await getDoc(gameDocRef);
            const calledNumbers = gameDocSnap.data().calledNumbers;

            if (checkBingo(playerCard, calledNumbers)) {
                await updateDoc(gameDocRef, { winner: userId, status: 'finished' });
            } else {
                showMessage("Not a bingo yet! Keep playing.");
            }
        });

        // Listen for real-time game state updates
        const listenForGameState = (gameDocRef, playerCard = null) => {
            onSnapshot(gameDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const gameData = docSnap.data();
                    
                    if (hostView.classList.contains('hidden') && playerView.classList.contains('hidden')) {
                         // Game is already finished before player joins, handle this edge case gracefully
                         if (gameData.status === 'finished') {
                            showMessage(`Game has finished. The winner is ${gameData.winner}.`);
                            showView(landingPage);
                            return;
                         }
                    }

                    if (gameData.hostId === userId) {
                        // This is the host
                        if (gameData.status === 'finished') {
                            showMessage(`Game Over! The winner is ${gameData.winner}.`);
                            callNumberBtn.disabled = true;
                        } else {
                            renderHostNumbersGrid(gameData.calledNumbers);
                            callNumberBtn.disabled = false;
                        }
                    } else if (playerCard) {
                        // This is a player
                        if (gameData.status === 'finished') {
                             if (gameData.winner === userId) {
                                 showMessage("BINGO! You won!");
                             } else {
                                 showMessage(`Game Over! The winner is ${gameData.winner}.`);
                             }
                             bingoBtn.disabled = true;
                        } else {
                            renderPlayerCard(playerCard, gameData.calledNumbers);
                            bingoBtn.disabled = false;
                        }
                    }
                } else {
                    showMessage("Game not found or has been deleted.");
                    showView(landingPage);
                }
            });
        };
        
        // Render the grid for the host
        const renderHostNumbersGrid = (calledNumbers) => {
            hostNumbersGrid.innerHTML = '';
            for (let i = 1; i <= 75; i++) {
                const cell = document.createElement('div');
                cell.classList.add('host-cell', 'rounded-md', 'select-none');
                cell.textContent = i;
                if (calledNumbers.includes(i)) {
                    cell.classList.add('bg-green-600', 'border-green-700');
                } else {
                    cell.classList.add('bg-gray-700', 'border-gray-600');
                }
                hostNumbersGrid.appendChild(cell);
            }
        };

        // Initialize the game
        window.onload = function() {
            // Ensure auth is ready before showing anything
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                if (user) {
                    unsubscribe();
                }
            });
        };
    </script>
</body>
</html>
